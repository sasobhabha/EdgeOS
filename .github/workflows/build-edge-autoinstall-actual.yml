# .github/workflows/build-edge-autoinstall-actual.yml
name: Build Edge Ubuntu - Actual Autoinstall ISO

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install ALL required tools
        run: |
          echo "ðŸ› ï¸ Installing ALL tools..."
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            xorriso \
            p7zip-full \
            isolinux \
            syslinux-common \
            genisoimage \
            mtools \
            dosfstools
          echo "âœ… All tools installed successfully"
          
      - name: Download Ubuntu
        run: |
          echo "ðŸ“¥ Downloading Ubuntu..."
          wget -q --show-progress -O ubuntu.iso https://releases.ubuntu.com/22.04.3/ubuntu-22.04.3-live-server-amd64.iso
          echo "âœ… Download complete: $(ls -lh ubuntu.iso)"
          
      - name: Extract ISO
        run: |
          echo "ðŸ“‚ Extracting ISO..."
          rm -rf iso-files
          mkdir -p iso-files
          7z x -oiso-files ubuntu.iso
          echo "âœ… Extraction complete"
          
      - name: Create autoinstall files INSIDE ISO
        run: |
          echo "ðŸ“ Creating autoinstall configuration INSIDE ISO..."
          
          # Create server directory inside ISO
          mkdir -p iso-files/server
          
          # Create user-data with FULL autoinstall
          cat > iso-files/server/user-data << 'EOF'
          #cloud-config
          autoinstall:
            version: 1
            refresh-installer:
              update: true
            early-commands:
              - ping -c1 8.8.8.8 || true
            locale: en_US
            keyboard:
              layout: us
            network:
              version: 2
              ethernets:
                eth0:
                  dhcp4: true
            storage:
              layout:
                name: direct
            identity:
              hostname: edge-ubuntu
              username: edge
              password: "edge"
            ssh:
              install-server: false
            packages:
              - xfce4
              - xfce4-goodies
              - lightdm
              - lightdm-gtk-greeter
              - curl
              - gnupg
              - software-properties-common
            user-data:
              disable_root: false
            late-commands:
              - |
                curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /target/etc/apt/trusted.gpg.d/microsoft.gpg
                echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /target/etc/apt/sources.list.d/microsoft-edge.list
              - curtin in-target --target=/target -- apt update
              - curtin in-target --target=/target -- apt install -y microsoft-edge-stable
              - |
                mkdir -p /target/etc/lightdm/lightdm.conf.d
                cat > /target/etc/lightdm/lightdm.conf.d/50-auto.conf << 'LIGHTDM'
                [Seat:*]
                autologin-user=edge
                autologin-user-timeout=0
                user-session=xfce
                LIGHTDM
              - |
                mkdir -p /target/home/edge/.config/autostart
                cat > /target/home/edge/.config/autostart/edge.desktop << 'EDGE_DESKTOP'
                [Desktop Entry]
                Type=Application
                Name=Microsoft Edge
                Exec=microsoft-edge-stable --start-fullscreen
                Hidden=false
                X-GNOME-Autostart-enabled=true
                EDGE_DESKTOP
                chown -R 1000:1000 /target/home/edge/.config
              - curtin in-target --target=/target -- update-alternatives --install /usr/bin/x-www-browser x-www-browser /usr/bin/microsoft-edge-stable 100
              - curtin in-target --target=/target -- update-alternatives --set x-www-browser /usr/bin/microsoft-edge-stable
          EOF
          
          # Create meta-data
          echo "instance-id: edge-ubuntu-auto" > iso-files/server/meta-data
          echo "local-hostname: edge-ubuntu" >> iso-files/server/meta-data
          
          echo "âœ… Autoinstall files created inside ISO"
          
      - name: Update boot configuration
        run: |
          echo "ðŸ”§ Updating boot configuration for autoinstall..."
          
          # Check which boot files exist
          echo "Boot files found:"
          find iso-files -name "*.cfg" -o -name "grub.cfg" 2>/dev/null | head -10
          
          # Update grub.cfg if it exists (Ubuntu Server)
          if [ -f "iso-files/boot/grub/grub.cfg" ]; then
            echo "Updating grub.cfg..."
            # Backup original
            cp iso-files/boot/grub/grub.cfg iso-files/boot/grub/grub.cfg.backup
            
            # Add autoinstall to kernel command line
            sed -i 's|/casper/vmlinuz|/casper/vmlinuz autoinstall ds=nocloud\\\\\\;s=/cdrom/server/|g' iso-files/boot/grub/grub.cfg
            echo "âœ… grub.cfg updated"
          fi
          
          # Also update isolinux/txt.cfg if it exists (for compatibility)
          if [ -f "iso-files/isolinux/txt.cfg" ]; then
            echo "Updating txt.cfg..."
            sed -i 's|---|autoinstall ds=nocloud;s=/cdrom/server/ ---|g' iso-files/isolinux/txt.cfg
            echo "âœ… txt.cfg updated"
          fi
          
      - name: Create NEW ISO using genisoimage (more reliable)
        run: |
          echo "ðŸŽ¨ Creating new ISO with autoinstall..."
          
          # First try with genisoimage (more reliable)
          genisoimage \
            -r \
            -V "Edge Ubuntu Auto" \
            -o edge-ubuntu-autoinstall.iso \
            -b isolinux/isolinux.bin \
            -c isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            -J -l \
            iso-files/
            
          echo "âœ… ISO created: edge-ubuntu-autoinstall.iso"
          ls -lh edge-ubuntu-autoinstall.iso
          
      - name: Upload the ACTUAL autoinstall ISO
        uses: actions/upload-artifact@v4
        with:
          name: edge-ubuntu-autoinstall-iso
          path: edge-ubuntu-autoinstall.iso
          retention-days: 7
          
      - name: Create success summary
        run: |
          echo "# ðŸŽ‰ ACTUAL AUTOINSTALL ISO CREATED!" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… BUILD SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Download: **edge-ubuntu-autoinstall.iso**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ What This ISO Does:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**BOOT â†’ INSTALL â†’ READY TO USE**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Boot from USB**" >> $GITHUB_STEP_SUMMARY
          echo "2. **Auto-installs Ubuntu Server**" >> $GITHUB_STEP_SUMMARY
          echo "3. **Auto-installs XFCE Desktop**" >> $GITHUB_STEP_SUMMARY
          echo "4. **Auto-installs Microsoft Edge**" >> $GITHUB_STEP_SUMMARY
          echo "5. **Configures auto-login**" >> $GITHUB_STEP_SUMMARY
          echo "6. **Sets Edge to auto-start**" >> $GITHUB_STEP_SUMMARY
          echo "7. **Reboots â†’ Ready to use**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ¨ Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ZERO manual steps**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Everything pre-configured**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Ready on first boot**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Edge launches automatically**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”‘ Default Credentials:" >> $GITHUB_STEP_SUMMARY
          echo "- **Username**: edge" >> $GITHUB_STEP_SUMMARY
          echo "- **Password**: edge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This is the ACTUAL autoinstall ISO you wanted!* ðŸš€" >> $GITHUB_STEP_SUMMARY
