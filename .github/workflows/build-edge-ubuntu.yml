# .github/workflows/build-edge-autoinstall.yml
name: Build Edge Ubuntu with Auto-Install

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xorriso p7zip-full
          
      - name: Download Ubuntu Server
        run: |
          wget -q --show-progress -O ubuntu.iso https://releases.ubuntu.com/22.04.3/ubuntu-22.04.3-live-server-amd64.iso
          
      - name: Create autoinstall ISO
        run: |
          # Extract ISO
          rm -rf iso-files
          mkdir -p iso-files
          7z x -oiso-files ubuntu.iso
          
          # Create autoinstall directory
          mkdir -p iso-files/server
          
          # Create user-data for FULL auto-installation
          cat > iso-files/server/user-data << 'EOF'
          #cloud-config
          autoinstall:
            version: 1
            
            # User configuration
            identity:
              hostname: edge-ubuntu
              username: edge
              password: "edge"
              
            # Network
            network:
              version: 2
              ethernets:
                eth0:
                  dhcp4: true
                  
            # Storage (automatic partitioning)
            storage:
              layout:
                name: direct
                
            # Packages to install
            packages:
              - xfce4
              - xfce4-goodies
              - lightdm
              - lightdm-gtk-greeter
              - curl
              - gnupg
              - software-properties-common
              
            # Late commands (run AFTER installation)
            late-commands:
              # Install Microsoft Edge
              - |
                curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /target/etc/apt/trusted.gpg.d/microsoft.gpg
                echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /target/etc/apt/sources.list.d/microsoft-edge.list
              - curtin in-target --target=/target -- apt update
              - curtin in-target --target=/target -- apt install -y microsoft-edge-stable
              
              # Configure auto-login
              - |
                mkdir -p /target/etc/lightdm/lightdm.conf.d
                cat > /target/etc/lightdm/lightdm.conf.d/50-auto.conf << 'LIGHTDM'
                [Seat:*]
                autologin-user=edge
                autologin-user-timeout=0
                user-session=xfce
                LIGHTDM
                
              # Create Edge autostart
              - |
                mkdir -p /target/home/edge/.config/autostart
                cat > /target/home/edge/.config/autostart/edge.desktop << 'EDGE_DESKTOP'
                [Desktop Entry]
                Type=Application
                Name=Microsoft Edge
                Exec=microsoft-edge-stable --start-fullscreen
                Hidden=false
                X-GNOME-Autostart-enabled=true
                EDGE_DESKTOP
                chown -R 1000:1000 /target/home/edge/.config
                
              # Set Edge as default browser
              - curtin in-target --target=/target -- update-alternatives --install /usr/bin/x-www-browser x-www-browser /usr/bin/microsoft-edge-stable 100
              - curtin in-target --target=/target -- update-alternatives --set x-www-browser /usr/bin/microsoft-edge-stable
              
            # SSH (disabled for security)
            ssh:
              install-server: false
          EOF
          
          # Create meta-data
          echo "instance-id: edge-ubuntu-auto" > iso-files/server/meta-data
          echo "local-hostname: edge-ubuntu" >> iso-files/server/meta-data
          
          # Update boot configuration to use autoinstall
          if [ -f iso-files/boot/grub/grub.cfg ]; then
            # Add autoinstall to kernel command line
            sed -i 's|---|autoinstall ds=nocloud;s=/cdrom/server/ ---|g' iso-files/boot/grub/grub.cfg
          fi
          
          # Create new ISO
          xorriso -as mkisofs \
            -r -V "Edge Ubuntu Auto" \
            -o edge-ubuntu-autoinstall.iso \
            -J -l \
            -b isolinux/isolinux.bin \
            -c isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            iso-files/
            
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: edge-ubuntu-autoinstall
          path: edge-ubuntu-autoinstall.iso
