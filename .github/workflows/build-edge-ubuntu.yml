# .github/workflows/edge-simple-fixed.yml
name: Build Edge Ubuntu (Fixed)

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Download Ubuntu
      run: |
        wget -q --show-progress -O ubuntu.iso https://releases.ubuntu.com/22.04.3/ubuntu-22.04.3-live-server-amd64.iso
        
    - name: Create Edge ISO
      run: |
        # Extract ISO
        rm -rf iso
        mkdir -p iso
        7z x -oiso ubuntu.iso
        
        # Check what files we have
        echo "ðŸ“ Files in boot/grub/:"
        ls -la iso/boot/grub/ 2>/dev/null || echo "No boot/grub directory"
        
        echo "ðŸ“ Files in isolinux/:"
        ls -la iso/isolinux/ 2>/dev/null || echo "No isolinux directory"
        
        # Create autoinstall config
        mkdir -p iso/nocloud
        cat > iso/nocloud/user-data << 'EOF'
        #cloud-config
        autoinstall:
          version: 1
          identity:
            hostname: edgepc
            username: edge
            password: "edge"
          packages:
            - xfce4
            - xfce4-goodies
            - lightdm
            - curl
            - gnupg
          late-commands:
            - curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /target/etc/apt/trusted.gpg.d/microsoft.gpg
            - echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /target/etc/apt/sources.list.d/microsoft-edge.list
            - curtin in-target --target=/target -- apt update
            - curtin in-target --target=/target -- apt install -y microsoft-edge-stable
            - mkdir -p /target/etc/lightdm/lightdm.conf.d
            - echo "[Seat:*]" > /target/etc/lightdm/lightdm.conf.d/50-auto.conf
            - echo "autologin-user=edge" >> /target/etc/lightdm/lightdm.conf.d/50-auto.conf
            - mkdir -p /target/home/edge/.config/autostart
            - echo "[Desktop Entry]" > /target/home/edge/.config/autostart/edge.desktop
            - echo "Type=Application" >> /target/home/edge/.config/autostart/edge.desktop
            - echo "Name=Microsoft Edge" >> /target/home/edge/.config/autostart/edge.desktop
            - echo "Exec=microsoft-edge-stable --start-fullscreen" >> /target/home/edge/.config/autostart/edge.desktop
            - echo "Hidden=false" >> /target/home/edge/.config/autostart/edge.desktop
            - chown -R 1000:1000 /target/home/edge/.config
        EOF
        
        echo "instance-id: edgepc" > iso/nocloud/meta-data
        
        # Update GRUB config (Ubuntu Server)
        if [ -f iso/boot/grub/grub.cfg ]; then
          echo "Updating grub.cfg..."
          # Simple replacement for vmlinuz line
          sed -i 's|/casper/vmlinuz quiet|/casper/vmlinuz quiet autoinstall ds=nocloud\\;s=/cdrom/nocloud/|g' iso/boot/grub/grub.cfg
        fi
        
        # Create ISO
        xorriso -as mkisofs \
          -r \
          -V "Edge Ubuntu" \
          -o edge-ubuntu.iso \
          -J -l \
          -b isolinux/isolinux.bin \
          -c isolinux/boot.cat \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          -eltorito-alt-boot \
          -e boot/grub/efi.img \
          -no-emul-boot \
          iso/
          
        echo "âœ… ISO created: edge-ubuntu.iso"
        ls -lh edge-ubuntu.iso
        
    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: edge-ubuntu
        path: edge-ubuntu.iso
