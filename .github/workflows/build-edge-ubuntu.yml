# .github/workflows/build-edge-simple.yml
name: Build Simple Edge Ubuntu

on:
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'Ubuntu version'
        required: true
        default: '22.04.3'
        type: string

jobs:
  build-simple:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y xorriso wget curl
      
    - name: Download ISO
      run: |
        VERSION="${{ github.event.inputs.ubuntu_version }}"
        wget -q --show-progress \
          -O ubuntu.iso \
          "https://releases.ubuntu.com/$VERSION/ubuntu-$VERSION-live-server-amd64.iso"
        
    - name: Extract and modify ISO
      run: |
        # Create directories
        mkdir -p iso extract
        
        # Mount or extract ISO
        7z x -oextract ubuntu.iso
        
        # Copy for modification
        cp -r extract/* iso/ || true
        
        # Create user-data for cloud-init
        mkdir -p iso/nocloud
        cat > iso/nocloud/user-data << 'EOF'
        #cloud-config
        autoinstall:
          version: 1
          identity:
            hostname: edge-ubuntu
            username: edge
            password: "$6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0"
          ssh:
            install-server: false
          packages:
            - xfce4
            - xfce4-goodies
            - lightdm
            - microsoft-edge-stable
          user-data:
            disable_root: false
          late-commands:
            - |
              cat > /target/etc/apt/sources.list.d/microsoft-edge.list << 'EDGELIST'
              deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main
              EDGELIST
            - |
              curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /target/etc/apt/trusted.gpg.d/microsoft.gpg
            - |
              cat > /target/etc/lightdm/lightdm.conf.d/50-auto-login.conf << 'LIGHTDM'
              [Seat:*]
              autologin-user=edge
              autologin-user-timeout=0
              user-session=xfce
              LIGHTDM
            - |
              mkdir -p /target/home/edge/.config/autostart
              cat > /target/home/edge/.config/autostart/edge.desktop << 'DESKTOP'
              [Desktop Entry]
              Type=Application
              Name=Microsoft Edge
              Exec=microsoft-edge-stable --start-fullscreen
              Hidden=false
              X-GNOME-Autostart-enabled=true
              DESKTOP
              chown -R 1000:1000 /target/home/edge/.config
        EOF
        
        cat > iso/nocloud/meta-data << 'EOF'
        instance-id: edge-ubuntu
        local-hostname: edge-ubuntu
        EOF
        
        # Modify boot command line
        sed -i 's|---|autoinstall ds=nocloud;s=/cdrom/nocloud/ ---|g' iso/boot/grub/grub.cfg
        sed -i 's|---|autoinstall ds=nocloud;s=/cdrom/nocloud/ ---|g' iso/isolinux/txt.cfg
        
        # Create new ISO
        xorriso -as mkisofs \
          -r -V "Edge Ubuntu" \
          -o edge-ubuntu.iso \
          -J -l \
          -b isolinux/isolinux.bin \
          -c isolinux/boot.cat \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          -eltorito-alt-boot \
          -e boot/grub/efi.img \
          -no-emul-boot \
          .
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-ubuntu-simple
        path: edge-ubuntu.iso
        retention-days: 7
