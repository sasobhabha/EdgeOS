# .github/workflows/edge-ubuntu-simple.yml
name: Edge Ubuntu Simple

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y wget xorriso p7zip-full
        
    - name: Download Ubuntu
      run: |
        wget -q --show-progress -O ubuntu.iso https://releases.ubuntu.com/22.04.3/ubuntu-22.04.3-live-server-amd64.iso
        
    - name: Extract and prepare
      run: |
        # Create directory
        mkdir -p iso-files
        
        # Extract ISO
        7z x -oiso-files ubuntu.iso
        
        # Show what we extracted
        echo "üìÅ Extracted files:"
        ls -la iso-files/ | head -20
        
    - name: Create autoinstall config
      run: |
        # Create autoinstall directory
        mkdir -p iso-files/server
        
        # Create user-data
        cat > iso-files/server/user-data << 'EOF'
        #cloud-config
        autoinstall:
          version: 1
          identity:
            hostname: edgepc
            username: edge
            password: "edge"
          packages:
            - xfce4
            - xfce4-goodies
            - lightdm
            - curl
            - gnupg
        EOF
        
        # Create meta-data
        echo "instance-id: edgepc" > iso-files/server/meta-data
        
    - name: Create ISO
      run: |
        # Check if xorriso is available
        if command -v xorriso >/dev/null 2>&1; then
          echo "‚úÖ xorriso is available"
          xorriso --version
        else
          echo "‚ùå xorriso not found, installing..."
          sudo apt-get install -y xorriso
        fi
        
        # Create ISO
        xorriso -as mkisofs \
          -r \
          -V "Edge Ubuntu" \
          -o edge-ubuntu.iso \
          -J \
          -c isolinux/boot.cat \
          -b isolinux/isolinux.bin \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          iso-files/
          
        echo "‚úÖ ISO created: edge-ubuntu.iso"
        ls -lh edge-ubuntu.iso
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-ubuntu
        path: edge-ubuntu.iso
