# .github/workflows/edge-preseed.yml
name: Edge Ubuntu with Preseed

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget mkisofs
        
    - name: Download Ubuntu
      run: |
        wget -O ubuntu.iso https://releases.ubuntu.com/22.04.3/ubuntu-22.04.3-live-server-amd64.iso
        
    - name: Create preseed file
      run: |
        # Create a preseed.cfg file
        cat > preseed.cfg << 'EOF'
        # Preseed configuration for Edge Ubuntu
        d-i debian-installer/locale string en_US
        d-i keyboard-configuration/xkb-keymap select us
        d-i netcfg/choose_interface select auto
        d-i netcfg/get_hostname string edgepc
        d-i netcfg/get_domain string local
        d-i mirror/http/proxy string
        
        # Partitioning
        d-i partman-auto/method string regular
        d-i partman-auto/choose_recipe select atomic
        d-i partman-partitioning/confirm_write_new_label boolean true
        d-i partman/choose_partition select finish
        d-i partman/confirm boolean true
        d-i partman/confirm_nooverwrite boolean true
        
        # User setup
        d-i passwd/user-fullname string Edge User
        d-i passwd/username string edge
        d-i passwd/user-password password edge
        d-i passwd/user-password-again password edge
        d-i user-setup/allow-password-weak boolean true
        d-i user-setup/encrypt-home boolean false
        
        # Packages
        tasksel tasksel/first multiselect ubuntu-desktop
        d-i pkgsel/include string xfce4 xfce4-goodies lightdm curl gnupg
        
        # Late commands
        d-i preseed/late_command string \
          in-target curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \| gpg --dearmor \> /etc/apt/trusted.gpg.d/microsoft.gpg ; \
          in-target echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" \> /etc/apt/sources.list.d/microsoft-edge.list ; \
          in-target apt update ; \
          in-target apt install -y microsoft-edge-stable ; \
          in-target mkdir -p /etc/lightdm/lightdm.conf.d ; \
          in-target echo "[Seat:*]" \> /etc/lightdm/lightdm.conf.d/50-auto.conf ; \
          in-target echo "autologin-user=edge" \>\> /etc/lightdm/lightdm.conf.d/50-auto.conf ; \
          mkdir -p /target/home/edge/.config/autostart ; \
          echo "[Desktop Entry]" \> /target/home/edge/.config/autostart/edge.desktop ; \
          echo "Type=Application" \>\> /target/home/edge/.config/autostart/edge.desktop ; \
          echo "Name=Microsoft Edge" \>\> /target/home/edge/.config/autostart/edge.desktop ; \
          echo "Exec=microsoft-edge-stable --start-fullscreen" \>\> /target/home/edge/.config/autostart/edge.desktop ; \
          chown -R 1000:1000 /target/home/edge/.config
        
        # Finish
        d-i finish-install/reboot_in_progress note
        EOF
        
    - name: Create ISO with preseed
      run: |
        # Extract ISO
        rm -rf iso-files
        mkdir -p iso-files
        7z x -oiso-files ubuntu.iso 2>/dev/null || true
        
        # Copy preseed file
        cp preseed.cfg iso-files/preseed.cfg
        
        # Create ISO
        mkisofs -r -V "Edge Ubuntu" -o edge-ubuntu.iso \
          -b isolinux/isolinux.bin -c isolinux/boot.cat \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -J -l iso-files/
          
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: edge-ubuntu-preseed
        path: edge-ubuntu.iso
